#!/bin/sh

set -e

VERSION="v2.12.0"

BUILD_DIR=$1
CACHE_DIR=$2
CACHED_BINARY="$CACHE_DIR/cloud-sql-proxy"

if [ ! -f "$CACHED_BINARY" ]; then
  echo "💾 Downloading cloud-sql-proxy"
  mkdir -p "$CACHE_DIR"
  wget https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/${VERSION}/cloud-sql-proxy.linux.amd64 -O "$CACHED_BINARY"
  chmod a+x "$CACHED_BINARY"
fi

BINARY_VERSION=$($CACHED_BINARY --version)

echo "☁️ Vendoring cloud-sql-proxy version $BINARY_VERSION into slug"
if [ ! -d "$BUILD_DIR/google/bin" ]; then
  mkdir -p "$BUILD_DIR/google/bin"
fi
cp "$CACHED_BINARY" "$BUILD_DIR/google/bin"
chmod +x "$BUILD_DIR/google/bin/cloud-sql-proxy"
PATH="$BUILD_DIR/google/bin:$PATH"

if [ ! -d "$BUILD_DIR/bin" ]; then
  mkdir "$BUILD_DIR/bin"
fi

cat >"$BUILD_DIR/bin/run-cloud-sql-proxy" <<EOF
#!/bin/sh
echo "🔐 Adding credentials JSON"
printf "%s" "\$GCLOUD_CREDENTIALS" | base64 --decode > /app/google/credentials.json
exec /app/google/bin/cloud-sql-proxy -credential_file=/app/google/credentials.json -instances=\$GCLOUD_INSTANCE -dir=/tmp &
EOF
chmod +x "$BUILD_DIR/bin/run-cloud-sql-proxy"

exit 0
